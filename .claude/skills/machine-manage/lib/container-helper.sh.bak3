#!/bin/bash
# Container Management Helper Library
# Abstracts differences between LXD (Linux) and OrbStack (macOS)
# Source this file in scripts that need container operations

# Detect the operating system
detect_os() {
    local os_type
    case "$(uname -s)" in
        Linux*)  os_type="linux" ;;
        Darwin*) os_type="macos" ;;
        *)       os_type="unknown" ;;
    esac
    echo "$os_type"
}

# Detect the container system
detect_container_system() {
    local os="$(detect_os)"

    case "$os" in
        linux)
            # On Linux, check for LXD
            if command -v lxc &> /dev/null; then
                echo "lxd"
            else
                echo "none"
            fi
            ;;
        macos)
            # On macOS, check for OrbStack
            if command -v orb &> /dev/null || command -v orbctl &> /dev/null; then
                echo "orbstack"
            else
                echo "none"
            fi
            ;;
        *)
            echo "none"
            ;;
    esac
}

# Print system info
print_system_info() {
    local os="$(detect_os)"
    local container_system="$(detect_container_system)"

    case "$os" in
        linux)
            case "$container_system" in
                lxd)
                    echo "Linux + LXD"
                    ;;
                *)
                    echo "Linux (LXD not found)"
                    ;;
            esac
            ;;
        macos)
            case "$container_system" in
                orbstack)
                    echo "macOS + OrbStack"
                    ;;
                *)
                    echo "macOS (OrbStack not found)"
                    ;;
            esac
            ;;
        *)
            echo "Unknown OS"
            ;;
    esac
}

# List containers/VMs
container_list() {
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc list --format=json | jq -r '.[] | "\(.name) \(.status)"'
            ;;
        orbstack)
            orb list
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Check if container/VM exists
container_exists() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc list --format=json | jq -e ".[] | select(.name == \"$name\")" > /dev/null 2>&1
            ;;
        orbstack)
            orb list | grep -q "^$name "
            ;;
        *)
            return 1
            ;;
    esac
}

# Check if container/VM is running
container_is_running() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            local status=$(lxc list --format=json | jq -r ".[] | select(.name == \"$name\") | .status" 2>/dev/null)
            [ "$status" = "Running" ]
            ;;
        orbstack)
            orb list | grep "^$name " | grep -q " running "
            ;;
        *)
            return 1
            ;;
    esac
}

# Execute command in container/VM with proper user account
# üîë ÈáçË¶ÅÔºöËá™Âä®‰ΩøÁî®Ê≠£Á°ÆÁöÑÁî®Êà∑Ë¥¶Âè∑Ôºàubuntu Áî®‰∫é LXDÔºådavidxu Áî®‰∫é OrbStackÔºâ
# üìù Áªü‰∏Ä‰ΩøÁî®bash shellÁ°Æ‰øùÂëΩ‰ª§ÊâßË°å‰∏ÄËá¥ÊÄßÂíåÂèØÈù†ÊÄß
container_exec() {
    local name="$1"
    shift
    local container_system="$(detect_container_system)"

    # Â∞ÜÊâÄÊúâÂèÇÊï∞ÂêàÂπ∂‰∏∫‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÔºàÂ§ÑÁêÜÂ∏¶Á©∫Ê†ºÁöÑÂèÇÊï∞Ôºâ
    local cmd="$*"

    case "$container_system" in
        lxd)
            # LXD: ‰ΩøÁî® ubuntu Áî®Êà∑Ôºà‰∏çËÉΩÁî® rootÔºåroot Êó†Ê≥ïËÆøÈóÆ ubuntu Áî®Êà∑ÁöÑ tmux ‰ºöËØùÔºâ
            # ‰ΩøÁî® bash -l ÂêØÂä®login shell‰ª•Âä†ËΩΩÁéØÂ¢ÉÈÖçÁΩÆ
            # Ê≥®ÊÑèÔºöÂÆπÂô®ÂÜÖÁöÑcmÂëΩ‰ª§ÈÄöËøá/usr/local/bin/cm symlinkÂú®PATH‰∏≠ÂèØÁî®
            lxc exec "$name" -- su - ubuntu -c "bash -l -c '$cmd'"
            ;;
        orbstack)
            # OrbStack: ‰ΩøÁî® davidxu Áî®Êà∑ÔºàËØ•Áî®Êà∑Êã•ÊúâÊâÄÊúâ‰ºöËØùÂíåÈÖçÁΩÆÔºâ
            # bash -l ËØªÂèñÁôªÂΩïshellÁöÑÈÖçÁΩÆÔºà.bash_profile, .bashrcÁ≠âÔºâ
            orb run --machine "$name" bash -l -c "$cmd"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Â¶ÇÈúÄ‰ª• root Ë∫´‰ªΩÊâßË°åÔºå‰ΩøÁî®Ëøô‰∏™ÂáΩÊï∞Ôºà‰∏çÊé®ËçêÔºâ
# Â§ßÂ§öÊï∞ÊÉÖÂÜµ‰∏ãÂ∫îËØ•Áî® container_execÔºà‰ºöËá™Âä®ÈÄâÊã©Ê≠£Á°ÆÁî®Êà∑Ôºâ
container_exec_as_root() {
    local name="$1"
    shift
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc exec "$name" -- "$@"
            ;;
        orbstack)
            orb run --machine "$name" "$@"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Start a container/VM
container_start() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc start "$name"
            ;;
        orbstack)
            orb start "$name"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Stop a container/VM
container_stop() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc stop "$name"
            ;;
        orbstack)
            orb stop "$name"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Clone a container/VM
container_clone() {
    local source="$1"
    local target="$2"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc copy "$source" "$target"
            ;;
        orbstack)
            orb clone "$source" "$target"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Delete a container/VM
container_delete() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            lxc delete "$name" --force
            ;;
        orbstack)
            orb delete "$name"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Open shell in container/VM with correct user account
# LXD: ubuntu user (‰∏çËÉΩÁî® rootÔºåroot Êó†Ê≥ïËÆøÈóÆ ubuntu Áî®Êà∑ÁöÑ tmux ‰ºöËØù)
# OrbStack: davidxu user (ËØ•Áî®Êà∑Êã•ÊúâÊâÄÊúâ‰ºöËØùÂíåÈÖçÁΩÆ)
container_shell() {
    local name="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            # LXD: ‰ΩøÁî® ubuntu Áî®Êà∑ËøõÂÖ•‰∫§‰∫íÂºè shell
            lxc exec "$name" -- su - ubuntu
            ;;
        orbstack)
            # OrbStack: Â∑≤Áªè‰ΩøÁî® davidxu Áî®Êà∑
            orb shell "$name"
            ;;
        *)
            echo "Error: No container system detected" >&2
            return 1
            ;;
    esac
}

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Get the command to enter a container shell
# Usage: get_container_shell_command <container_name>
get_container_shell_command() {
    local container="$1"
    local container_system="$(detect_container_system)"

    case "$container_system" in
        lxd)
            # For LXD, use lxc exec or mm if available
            if command -v mm &> /dev/null; then
                echo "mm shell $container"
            else
                echo "lxc exec $container -- bash -c 'cd ~ && exec bash -l'"
            fi
            ;;
        orbstack)
            # For OrbStack, use orb command
            echo "orb $container"
            ;;
        *)
            echo "echo 'No container system detected' && bash"
            ;;
    esac
}
